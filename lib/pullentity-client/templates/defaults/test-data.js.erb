# Don't edit this file unless you know you are doing
#= require "underscore-min"
#= require "mustache"

$(document).ready ->
  template = undefined
  html = undefined
  window.base_image_path = "http://pullentity.com"
  window.theme = ""
  window.list_theme = ""
  window.mustache_themes = ""
  window.data = {}
  window.data =
    site_link: "/"
    public_url: "http://artenlinea.com"
    project: {}
    photos: []
    url: ->
      (text, render) ->
        text = render(text)
        url = text.trim().toLowerCase().split("tuts+")[0] + ".tutsplus.com"
        "<a href=\"" + url + "\">" + text + "</a>"

  $.getJSON "/assets/javascripts/pullentity_data.json", (json_data) ->

    items = []
    #debugger
    window.data["site"] =
      name: json_data.name
      subdomain: json_data.subdomain

    window.data["sections"] = []

    $.each json_data.sections, (key, val) ->
      window.data["sections"].push val

    window.data["projects"] = []
    $.each json_data.projects, (key, val) ->
      window.data["projects"].push  val

    window.init_themes()

  # layout initialization
  window.init_themes = ()->

    template = $("#layout").html()
    window.mustache_themes = $(".pullentity-themes")

    window.list_theme =  $(".pullentity-themes#list")

    window.data["project"] = window.data.projects[0]

    fill_projects(window.data["project"].photos)

    layout = Mustache.to_html(template, data)

    $("body").html layout

    $(window).on "hashchange", (e) ->
      window.theme = ""
      window.data["project"] = {}
      # find section by window.location, then find project and theme
      find_in_section()

  # points path for remote image resources
  window.remote_path = (path)->
    "http://pullentity.com/#{path}"

  # builds the project photos hsh
  window.fill_projects = (collection)->
    window.data["photos"] = []
    $.each collection, (key, val) ->
      window.data["photos"].push
       img_medium: remote_path( val.image.image.medium.url)
       img_large: remote_path(val.image.image.large.url)
       img_thumb: remote_path(val.image.image.thumb.url)
       title: val.title
       caption: val.caption

  # display project or list
  window.display_project_or_list = (_tis)->

    if _tis.list_or_project == "project"

      console.log("trying theme #{window.data["project"].theme_template.name}")
      window.theme = $($(_.find($(window.mustache_themes), (num) ->
        $(num).attr("id") == window.data["project"].theme_template.name
      )).html())

      fill_projects(window.data["project"].photos)
      view = Mustache.to_html($(window.theme[0]).html(), window.data)
      $("#content").html view

    else
      console.log "should be list!!"
      data_projects = data_projects_for_list()
      view = Mustache.to_html($(window.list_theme).html(), data_projects)
      $("#content").html view

    false

    #unless dummy?
    #  console.warn("please create file in views/themes/#{window.data["project"].theme_template.name}.haml")



  window.data_projects_for_list = ()->
    section = _.find( window.data["sections"] , (num) ->
      num.public_url == window.location.hash
    )

    a = _.filter(window.data["projects"], (num) ->
      true  if num.section.public_url is "#image"
    )
    {section: section, projects: a}

  # maps project for section
  window.find_in_section = ()->

    $.each window.data.sections, ()->

      if this.public_url == window.location.hash
        # find project
        _tis = this
        _tis.finds = false

        $.each window.data.projects, ()->
          if this.section.public_url == _tis.public_url
            window.data["project"] = this
            console.log window.data["project"]
            display_project_or_list(_tis)



